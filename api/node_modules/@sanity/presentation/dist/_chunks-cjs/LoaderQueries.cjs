"use strict";var e=require("react/jsx-runtime"),t=require("react"),n=require("@sanity/client/csm"),r=require("mendoza"),s=require("mnemonist/lru-cache-with-delete"),c=require("sanity"),a=require("./index.cjs");function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var u=o(s);function i(e){return document.addEventListener("visibilitychange",e),()=>document.removeEventListener("visibilitychange",e)}const l=t.memo((function(n){const{cache:s,client:c,turboIds:o,setDocumentsCacheLastUpdated:u}=n,[i,l]=t.useState([]);return t.useEffect((()=>{const e=new Set(i.flat()),t=new Set;for(const n of o)!e.has(n)&&!s.has(n)&&t.add(n);const n=[...t].slice(0,a.e);0!==n.length&&l((e=>[...e.slice(-a.e),n]))}),[i,s,o]),t.useEffect((()=>{const e=c.listen("*",{},{events:["mutation"],effectFormat:"mendoza",includePreviousRevision:!1,includeResult:!1,tag:"presentation-loader"}).subscribe((e=>{if("mutation"===e.type&&"disappear"===e.transition&&s.delete(e.documentId)&&u(Date.now()),"mutation"!==e.type||!e.effects?.apply?.length)return;const t=s.peek(e.documentId);if(t){const n={...t};delete n._rev;const c=r.applyPatch(n,e.effects.apply);s.set(e.documentId,c),u(Date.now())}}));return()=>e.unsubscribe()}),[s,c,u]),e.jsx(e.Fragment,{children:i.map((t=>e.jsx(d,{cache:s,client:c,ids:t,setDocumentsCacheLastUpdated:u},JSON.stringify(t))))})})),d=t.memo((function(e){const{client:n,cache:r,ids:s,setDocumentsCacheLastUpdated:c}=e;return t.useEffect((()=>{const e=s.filter((e=>!r.has(e)));0!==e.length&&n.getDocuments(e).then((e=>{for(const t of e)t&&t?._id&&(r.set(t._id,t),c(Date.now()))}),console.error)}),[r,n,s,c]),null}));function p(e){const{cache:n,projectId:r,dataset:s,perspective:c,query:a,client:o,refreshInterval:u,liveDocument:l,channel:d,documentsCacheLastUpdated:p}=e,f=function(e){const n=t.useMemo((()=>JSON.stringify(e||{})),[e]);return t.useMemo((()=>JSON.parse(n)),[n])}(e.params),h=function(e){const{cache:n,liveDocument:r,client:s,refreshInterval:c,query:a,params:o,perspective:u,documentsCacheLastUpdated:l}=e,[d,p]=t.useState(null),{projectId:f,dataset:h}=t.useMemo((()=>{const{projectId:e,dataset:t}=s.config();return{projectId:e,dataset:t}}),[s]),[v,g]=t.useState(null);if(v)throw v;const[y,w]=function(e){const{refreshInterval:n}=e,r=function(){const[e,n]=t.useState(!1);t.useEffect((()=>{n(navigator.onLine);const e=()=>n(!0),t=()=>n(!1);return window.addEventListener("online",e),window.addEventListener("offline",t),()=>{window.removeEventListener("online",e),window.removeEventListener("offline",t)}}),[]);const r=t.useSyncExternalStore(i,(()=>document.visibilityState),(()=>"hidden"));return!e||"hidden"===r}(),[s,c]=t.useState("hit"),a=t.useCallback((()=>(c("inflight"),()=>c("hit"))),[]);return t.useEffect((()=>{if(!n||"hit"!==s)return;const e=setTimeout((()=>c("stale")),n);return()=>clearTimeout(e)}),[n,s]),t.useEffect((()=>{if("hit"!==s)return;const e=()=>c("stale");return window.addEventListener("focus",e),()=>window.removeEventListener("focus",e)}),[n,s]),t.useEffect((()=>{r&&"hit"===s&&c("stale"),!r&&"stale"===s&&c("refresh")}),[r,s]),[s,a]}({refreshInterval:c}),S="refresh"===y||"inflight"===y;return t.useEffect((()=>{if(!S)return;let e=!1,t=!1;const n=new AbortController;async function r(){const{signal:r}=n;t=!0;const{result:c,resultSourceMap:i}=await s.fetch(a,o,{tag:"presentation-loader",signal:r,perspective:u,filterResponse:!1});t=!1,r.aborted||(p({result:c,resultSourceMap:i}),e=!0)}const c=w();return r().catch((e=>{t=!1,"AbortError"!==e.name&&g(e)})).finally(c),()=>{!e&&!t&&n.abort()}}),[s,h,r,o,u,f,a,S,w]),t.useMemo((()=>l&&d?.resultSourceMap?{result:m(n,r,d.result,u,d.resultSourceMap),resultSourceMap:d.resultSourceMap}:d),[n,l,r,u,d])}({cache:n,client:o,liveDocument:l,params:f,perspective:c,query:a,refreshInterval:u,documentsCacheLastUpdated:p}),v=h?.result,g=h?.resultSourceMap;return t.useEffect((()=>{g&&d.send("loaders","loader/query-change",{projectId:r,dataset:s,perspective:c,query:a,params:f,result:v,resultSourceMap:g})}),[d,s,f,c,r,a,v,g]),null}d.displayName="GetDocuments";let f=!1;function m(e,t,r,s,c){if("raw"===s)throw new Error("turboChargeResultIfSourceMap does not support raw perspective");return n.applySourceDocuments(r,c,(r=>{if(!r._projectId)return t?._id&&n.getPublishedId(t._id)===n.getPublishedId(r._id)?t:e.get(r._id);f||(console.warn("Cross dataset references are not supported yet, ignoring source document",r),f=!0)}),((e,{previousValue:t})=>"number"==typeof e&&"string"==typeof t?`${e}`:e),s)}exports.default=function(n){const{liveDocument:r,channel:s,perspective:o,liveQueries:i,documentsOnPage:d}=n,[f]=t.useState((()=>new u.default(a.L))),m=c.useClient({apiVersion:"2023-10-16"}),h=t.useMemo((()=>m.config()),[m]),v=t.useMemo((()=>m.withConfig({resultSourceMap:"withKeyArraySelector"})),[m]);t.useEffect((()=>{if(s){const{projectId:e,dataset:t}=h;s.send("loaders","loader/perspective",{projectId:e,dataset:t,perspective:o})}}),[s,h,o]);const g=t.useMemo((()=>{const e=d.map((({_id:e})=>e)),t=[...new Set(e)],n=f.capacity;return t.length>=n&&(t.length=n),t}),[f.capacity,d]),[y,w]=t.useState(0);return e.jsxs(e.Fragment,{children:[e.jsx(l,{cache:f,client:v,turboIds:g,setDocumentsCacheLastUpdated:w}),Object.entries(i).map((([t,{query:n,params:c,perspective:a}])=>e.jsx(p,{cache:f,projectId:h.projectId,dataset:h.dataset,perspective:a,query:n,params:c,channel:s,client:v,refreshInterval:o?2e3:0,liveDocument:r,documentsCacheLastUpdated:y},`${t}${a}`)))]})},exports.turboChargeResultIfSourceMap=m;//# sourceMappingURL=LoaderQueries.cjs.map
